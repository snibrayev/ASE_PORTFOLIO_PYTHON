{% extends "base.html" %}

{% block content %}

<style>
/* ‚îÄ‚îÄ ticker bar ‚îÄ‚îÄ */
.ticker-bar {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 18px;
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 0.78rem;
    letter-spacing: 0.06em;
    margin-bottom: 28px;
    overflow: hidden;
}
.ticker-dot {
    width: 7px; height: 7px;
    background: var(--success);
    border-radius: 50%;
    flex-shrink: 0;
    animation: pulse 1.8s ease infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50%       { opacity: 0.4; transform: scale(0.7); }
}
.ticker-label { color: var(--text-muted); text-transform: uppercase; }
.ticker-value { color: var(--accent); font-weight: 700; }
.ticker-sep   { color: var(--border); }
#live-clock   { color: var(--text-secondary); font-variant-numeric: tabular-nums; }

/* ‚îÄ‚îÄ page header ‚îÄ‚îÄ */
.market-header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
}
.market-header-left h2 {
    font-family: var(--font-display);
    font-size: 3rem;
    letter-spacing: 0.08em;
    color: var(--accent);
    line-height: 1;
}
.market-header-left p {
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-top: 4px;
}

/* ‚îÄ‚îÄ currency form inline ‚îÄ‚îÄ */
.currency-form {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
}
.currency-form label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin: 0;
    white-space: nowrap;
}
.currency-form input {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 0.9rem;
    padding: 6px 10px;
    width: 80px;
    text-transform: uppercase;
    outline: none;
    transition: border-color var(--transition);
}
.currency-form input:focus { border-color: var(--accent); }
.currency-form button {
    background: var(--accent);
    color: #111;
    border: none;
    border-radius: var(--radius-sm);
    padding: 7px 16px;
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background var(--transition), transform var(--transition);
}
.currency-form button:hover { background: #f0d560; transform: translateY(-1px); }

/* ‚îÄ‚îÄ stat cards ‚îÄ‚îÄ */
.stat-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 14px;
    margin-bottom: 24px;
}
.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: 3px solid var(--accent);
    border-radius: var(--radius-md);
    padding: 20px 18px;
    position: relative;
    overflow: hidden;
    transition: transform var(--transition), box-shadow var(--transition);
    opacity: 0;
    animation: fadeUp 0.5s ease forwards;
}
.stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 28px rgba(0,0,0,0.35); }
.stat-card::after {
    content: '';
    position: absolute;
    bottom: 0; right: 0;
    width: 80px; height: 80px;
    background: radial-gradient(circle, var(--accent-glow), transparent 70%);
    pointer-events: none;
}
.stat-card:nth-child(1) { animation-delay: 0.05s; }
.stat-card:nth-child(2) { animation-delay: 0.12s; }
.stat-card:nth-child(3) { animation-delay: 0.19s; }
.stat-card:nth-child(4) { animation-delay: 0.26s; }
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
}
.stat-card .sc-label {
    font-size: 0.7rem; font-weight: 600;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--text-muted); margin-bottom: 8px;
}
.stat-card .sc-value {
    font-family: var(--font-display);
    font-size: 1.9rem; letter-spacing: 0.03em;
    color: var(--text-primary); line-height: 1;
}
.stat-card .sc-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; }

/* ‚îÄ‚îÄ panel ‚îÄ‚îÄ */
.panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 26px 24px;
    position: relative;
    overflow: hidden;
    margin-bottom: 18px;
}
.panel-title {
    font-family: var(--font-display);
    font-size: 1.3rem; letter-spacing: 0.07em;
    color: var(--text-primary); margin-bottom: 18px;
    display: flex; align-items: center; gap: 10px;
}
.panel-title-icon {
    width: 26px; height: 26px;
    background: var(--accent-glow);
    border: 1px solid var(--accent);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.85rem;
}

/* ‚îÄ‚îÄ CHART PANEL ‚îÄ‚îÄ */
.chart-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
}
.chart-toggle {
    display: flex;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
}
.chart-toggle button {
    background: none;
    border: none;
    padding: 7px 18px;
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.07em;
    cursor: pointer;
    transition: background var(--transition), color var(--transition);
}
.chart-toggle button.active {
    background: var(--accent);
    color: #111;
}
.chart-meta {
    font-size: 0.78rem;
    color: var(--text-muted);
    letter-spacing: 0.05em;
}
.chart-meta span { color: var(--accent); font-weight: 600; }

.chart-wrapper {
    position: relative;
    height: 280px;
}

.chart-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: var(--text-muted);
    font-size: 0.85rem;
    letter-spacing: 0.06em;
}
.chart-spinner {
    width: 28px; height: 28px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.chart-error {
    text-align: center;
    padding: 40px;
    color: var(--danger);
    font-size: 0.85rem;
}

/* ‚îÄ‚îÄ chart stat bar ‚îÄ‚îÄ */
.chart-stats-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 18px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
}
.chart-stat-item { text-align: center; }
.chart-stat-item .csi-label {
    font-size: 0.68rem; font-weight: 600;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-muted); margin-bottom: 4px;
}
.chart-stat-item .csi-value {
    font-family: var(--font-display);
    font-size: 1.1rem; letter-spacing: 0.04em;
    color: var(--text-primary);
}
.csi-value.positive { color: var(--success); }
.csi-value.negative { color: var(--danger); }

/* ‚îÄ‚îÄ two-col lower ‚îÄ‚îÄ */
.lower-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    margin-bottom: 18px;
}
@media (max-width: 820px) { .lower-grid { grid-template-columns: 1fr; } }

/* ‚îÄ‚îÄ gold calculator ‚îÄ‚îÄ */
.calc-input-row {
    display: flex; gap: 10px; align-items: center; margin-bottom: 14px;
}
.calc-input-row input {
    flex: 1;
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text-primary);
    font-family: var(--font-body); font-size: 1rem;
    padding: 10px 12px; outline: none;
    transition: border-color var(--transition);
}
.calc-input-row input:focus { border-color: var(--accent); }
.calc-unit-toggle {
    display: flex;
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); overflow: hidden;
}
.calc-unit-toggle button {
    background: none; border: none; padding: 8px 14px;
    color: var(--text-muted); font-family: var(--font-body);
    font-size: 0.8rem; font-weight: 600; letter-spacing: 0.06em;
    cursor: pointer; transition: background var(--transition), color var(--transition);
}
.calc-unit-toggle button.active { background: var(--accent); color: #111; }
.calc-result {
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: var(--radius-md); padding: 18px;
    text-align: center; min-height: 72px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.calc-result-value {
    font-family: var(--font-display);
    font-size: 2.2rem; letter-spacing: 0.04em; color: var(--accent); line-height: 1;
}
.calc-result-label {
    font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;
    letter-spacing: 0.08em; text-transform: uppercase;
}

/* ‚îÄ‚îÄ currency comparison ‚îÄ‚îÄ */
.currency-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
.currency-table th {
    font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--text-muted);
    padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left;
}
.currency-table td {
    padding: 10px 10px; border-bottom: 1px solid rgba(46,46,46,0.6);
    color: var(--text-secondary); transition: background var(--transition);
}
.currency-table tr:hover td { background: var(--surface-2); color: var(--text-primary); }
.currency-table tr:last-child td { border-bottom: none; }
.flag { margin-right: 6px; font-size: 1rem; }
.highlight-row td { color: var(--accent) !important; font-weight: 600; }

/* ‚îÄ‚îÄ breakdown table ‚îÄ‚îÄ */
.breakdown-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
.breakdown-table th {
    font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--text-muted);
    padding: 10px 14px; border-bottom: 1px solid var(--border);
    background: var(--surface-2); text-align: left;
}
.breakdown-table td {
    padding: 12px 14px; border-bottom: 1px solid var(--border); color: var(--text-secondary);
}
.breakdown-table tr:hover td { background: var(--surface-2); }
.breakdown-table tr:last-child td { border-bottom: none; }

/* ‚îÄ‚îÄ no data ‚îÄ‚îÄ */
.no-data { text-align: center; padding: 40px 20px; color: var(--text-muted); }
.no-data-icon { font-size: 2.5rem; margin-bottom: 12px; }
.no-data p { font-size: 0.9rem; letter-spacing: 0.06em; }
</style>

<!-- Chart.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<div style="max-width: 1100px; margin: 0 auto;">

    {# Ticker #}
    <div class="ticker-bar">
        <span class="ticker-dot"></span>
        <span class="ticker-label">Live</span>
        {% if market_data %}
            <span class="ticker-value">XAU/USD ${{ market_data.gold_usd_oz }}</span>
            <span class="ticker-sep">|</span>
            <span class="ticker-label">1 USD =</span>
            <span class="ticker-value">{{ market_data.rate }} {{ market_data.currency }}</span>
            <span class="ticker-sep">|</span>
        {% endif %}
        <span class="ticker-label">üïê</span>
        <span id="live-clock">--:--:--</span>
    </div>

    {# Header #}
    <div class="market-header">
        <div class="market-header-left">
            <h2>Market Dashboard</h2>
            <p>Live Gold Prices &amp; Currency Exchange</p>
        </div>
        <form method="POST" class="currency-form">
            {{ form.hidden_tag() }}
            <label for="{{ form.currency.id }}">Currency</label>
            {{ form.currency(class="", placeholder="AED", value=market_data.currency if market_data else "AED", id=form.currency.id) }}
            {{ form.submit(class="") }}
        </form>
    </div>

    {% if error %}
        <div class="weather-error" style="margin-bottom: 20px;">‚ö† {{ error }}</div>
    {% endif %}

    {% if market_data %}

    {# Stat Cards #}
    <div class="stat-row">
        <div class="stat-card">
            <div class="sc-label">Gold ‚Äî USD / oz</div>
            <div class="sc-value" data-count="{{ market_data.gold_usd_oz }}" data-prefix="$" data-decimals="2">$0</div>
            <div class="sc-sub">Troy ounce spot price</div>
        </div>
        <div class="stat-card">
            <div class="sc-label">Gold ‚Äî {{ market_data.currency }} / oz</div>
            <div class="sc-value" data-count="{{ market_data.gold_target_oz }}" data-suffix=" {{ market_data.currency }}" data-decimals="2">0</div>
            <div class="sc-sub">Converted at live rate</div>
        </div>
        <div class="stat-card">
            <div class="sc-label">Gold ‚Äî USD / gram</div>
            <div class="sc-value" data-count="{{ market_data.gold_usd_g }}" data-prefix="$" data-decimals="2">$0</div>
            <div class="sc-sub">Per gram (31.1g / oz)</div>
        </div>
        <div class="stat-card">
            <div class="sc-label">Exchange Rate</div>
            <div class="sc-value" data-count="{{ market_data.rate }}" data-decimals="4">0</div>
            <div class="sc-sub">1 USD ‚Üí {{ market_data.currency }}</div>
        </div>
    </div>

    {# ‚îÄ‚îÄ CHART PANEL ‚îÄ‚îÄ #}
    <div class="panel">
        <div class="chart-controls">
            <div class="panel-title" style="margin-bottom:0;">
                <span class="panel-title-icon">üìà</span>
                Gold Price History (USD/oz)
            </div>
            <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap;">
                <div class="chart-meta">
                    Range: <span id="chart-range-label">30 days</span> &nbsp;|&nbsp;
                    Change: <span id="chart-change-label">‚Äî</span>
                </div>
                <div class="chart-toggle">
                    <button type="button" data-days="7">7D</button>
                    <button type="button" data-days="14">14D</button>
                    <button type="button" data-days="30" class="active">30D</button>
                </div>
            </div>
        </div>

        <div class="chart-wrapper">
            <div class="chart-loading" id="chart-loading">
                <div class="chart-spinner"></div>
                <span>Fetching historical data‚Ä¶</span>
            </div>
            <div class="chart-error" id="chart-error" style="display:none;"></div>
            <canvas id="goldChart" style="display:none;"></canvas>
        </div>

        <div class="chart-stats-bar">
            <div class="chart-stat-item">
                <div class="csi-label">Period High</div>
                <div class="csi-value" id="cs-high">‚Äî</div>
            </div>
            <div class="chart-stat-item">
                <div class="csi-label">Period Low</div>
                <div class="csi-value" id="cs-low">‚Äî</div>
            </div>
            <div class="chart-stat-item">
                <div class="csi-label">Period Open</div>
                <div class="csi-value" id="cs-open">‚Äî</div>
            </div>
            <div class="chart-stat-item">
                <div class="csi-label">Latest Close</div>
                <div class="csi-value" id="cs-close">‚Äî</div>
            </div>
            <div class="chart-stat-item">
                <div class="csi-label">% Change</div>
                <div class="csi-value" id="cs-pct">‚Äî</div>
            </div>
            <div class="chart-stat-item">
                <div class="csi-label">Avg Price</div>
                <div class="csi-value" id="cs-avg">‚Äî</div>
            </div>
        </div>
    </div>

    {# Two-col: Calculator + Currency Table #}
    <div class="lower-grid">

        {# Gold Calculator #}
        <div class="panel">
            <div class="panel-title">
                <span class="panel-title-icon">‚öñ</span>
                Gold Value Calculator
            </div>
            <div class="calc-input-row">
                <input type="number" id="calc-amount" placeholder="Enter amount..." min="0" step="0.01" />
                <div class="calc-unit-toggle">
                    <button type="button" class="active" data-unit="grams">g</button>
                    <button type="button" data-unit="oz">oz</button>
                    <button type="button" data-unit="kg">kg</button>
                    <button type="button" data-unit="tola">tola</button>
                </div>
            </div>
            <div class="calc-result" id="calc-result-box">
                <div class="calc-result-value" id="calc-result-usd">‚Äî</div>
                <div class="calc-result-label" id="calc-result-label">Enter an amount above</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
                <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center;">
                    <div style="font-size:0.7rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;">USD</div>
                    <div style="font-family:var(--font-display);font-size:1.3rem;color:var(--text-primary);" id="calc-usd-side">‚Äî</div>
                </div>
                <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center;">
                    <div style="font-size:0.7rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;">{{ market_data.currency }}</div>
                    <div style="font-family:var(--font-display);font-size:1.3rem;color:var(--accent);" id="calc-target-side">‚Äî</div>
                </div>
            </div>
        </div>

        {# Currency Comparison #}
        <div class="panel">
            <div class="panel-title">
                <span class="panel-title-icon">üåê</span>
                Gold Price in Major Currencies
            </div>
            <table class="currency-table">
                <thead>
                    <tr><th>Currency</th><th>Per Gram</th><th>Per Ounce</th></tr>
                </thead>
                <tbody id="currency-comparison-body"></tbody>
            </table>
        </div>
    </div>

    {# Full Breakdown #}
    <div class="panel">
        <div class="panel-title">
            <span class="panel-title-icon">üìã</span>
            Full Market Breakdown
        </div>
        <table class="breakdown-table">
            <thead>
                <tr><th>Metric</th><th>Value</th><th>Unit</th><th>Source</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td>Spot Price (USD)</td>
                    <td style="color:var(--text-primary);font-weight:600;">${{ market_data.gold_usd_oz }}</td>
                    <td>USD / troy oz</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">GoldAPI.io</td>
                </tr>
                <tr>
                    <td>Spot Price ({{ market_data.currency }})</td>
                    <td style="color:var(--accent);font-weight:600;">{{ market_data.gold_target_oz }}</td>
                    <td>{{ market_data.currency }} / troy oz</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">Calculated</td>
                </tr>
                <tr>
                    <td>Price per Gram (USD)</td>
                    <td style="color:var(--text-primary);font-weight:600;">${{ market_data.gold_usd_g }}</td>
                    <td>USD / g</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">Calculated</td>
                </tr>
                <tr>
                    <td>Price per Gram ({{ market_data.currency }})</td>
                    <td style="color:var(--accent);font-weight:600;">{{ market_data.gold_target_g }}</td>
                    <td>{{ market_data.currency }} / g</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">Calculated</td>
                </tr>
                <tr>
                    <td>Exchange Rate</td>
                    <td style="color:var(--text-primary);font-weight:600;">{{ market_data.rate }}</td>
                    <td>USD ‚Üí {{ market_data.currency }}</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">Open Exchange Rates</td>
                </tr>
                <tr>
                    <td>Last Update</td>
                    <td style="color:var(--text-secondary);">{{ market_data.updated }}</td>
                    <td>UTC</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">System</td>
                </tr>
            </tbody>
        </table>
    </div>

    {% else %}
    <div class="panel">
        <div class="no-data">
            <div class="no-data-icon">üìä</div>
            <p>Enter a currency code above and hit <strong style="color:var(--accent);">Update</strong> to load live market data.</p>
            <p style="margin-top:8px;font-size:0.8rem;">Try: AED ¬∑ EUR ¬∑ GBP ¬∑ JPY ¬∑ INR ¬∑ SGD</p>
        </div>
    </div>
    {% endif %}

</div>

{# ‚îÄ‚îÄ JAVASCRIPT ‚îÄ‚îÄ #}
<script>
/* ‚îÄ‚îÄ live clock ‚îÄ‚îÄ */
function updateClock() {
    const now = new Date();
    const uae = new Date(now.getTime() + (4 * 60 * 60 * 1000));
    const hh  = String(uae.getUTCHours()).padStart(2, '0');
    const mm  = String(uae.getUTCMinutes()).padStart(2, '0');
    const ss  = String(uae.getUTCSeconds()).padStart(2, '0');
    document.getElementById('live-clock').textContent = hh + ':' + mm + ':' + ss + ' GMT+4';
}
updateClock();
setInterval(updateClock, 1000);

{% if market_data %}

/* ‚îÄ‚îÄ animated counters ‚îÄ‚îÄ */
function animateCount(el) {
    const target   = parseFloat(el.dataset.count);
    const prefix   = el.dataset.prefix  || '';
    const suffix   = el.dataset.suffix  || '';
    const decimals = parseInt(el.dataset.decimals) || 0;
    const start    = performance.now();
    const duration = 900;
    function step(now) {
        const p = Math.min((now - start) / duration, 1);
        const e = 1 - Math.pow(1 - p, 3);
        el.textContent = prefix + (target * e).toLocaleString(undefined, {
            minimumFractionDigits: decimals, maximumFractionDigits: decimals
        }) + suffix;
        if (p < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}
document.querySelectorAll('[data-count]').forEach(animateCount);

/* ‚îÄ‚îÄ calculator ‚îÄ‚îÄ */
const GOLD_USD_G  = {{ market_data.gold_usd_g }};
const GOLD_USD_OZ = {{ market_data.gold_usd_oz }};
const RATE        = {{ market_data.rate }};
const TARGET_CUR  = "{{ market_data.currency }}";
const unitFactors = { grams: 1, oz: 31.1035, kg: 1000, tola: 11.6638 };
let activeUnit = 'grams';

document.querySelectorAll('.calc-unit-toggle button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.calc-unit-toggle button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeUnit = btn.dataset.unit;
        recalculate();
    });
});
document.getElementById('calc-amount').addEventListener('input', recalculate);

function recalculate() {
    const raw = parseFloat(document.getElementById('calc-amount').value);
    const rv  = document.getElementById('calc-result-usd');
    const rl  = document.getElementById('calc-result-label');
    const us  = document.getElementById('calc-usd-side');
    const ts  = document.getElementById('calc-target-side');
    const fmt = (n, p='') => p + n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    if (isNaN(raw) || raw <= 0) {
        rv.textContent = '‚Äî'; rl.textContent = 'Enter an amount above';
        us.textContent = '‚Äî'; ts.textContent = '‚Äî'; return;
    }
    const grams  = raw * unitFactors[activeUnit];
    const usdVal = grams * GOLD_USD_G;
    const tgtVal = usdVal * RATE;
    rv.textContent = fmt(usdVal, '$');
    rl.textContent = `${raw} ${activeUnit} ‚âà ${fmt(tgtVal)} ${TARGET_CUR}`;
    us.textContent = fmt(usdVal, '$');
    ts.textContent = fmt(tgtVal);
}

/* ‚îÄ‚îÄ currency comparison table ‚îÄ‚îÄ */
const APPROX_RATES = {
    USD:1, AED:3.6725, EUR:0.92, GBP:0.79,
    JPY:149.5, INR:83.1, SAR:3.75, SGD:1.34,
};
APPROX_RATES[TARGET_CUR] = RATE;
const MAJOR = [
    {code:'AED',flag:'üá¶üá™',name:'UAE Dirham'},
    {code:'USD',flag:'üá∫üá∏',name:'US Dollar'},
    {code:'EUR',flag:'üá™üá∫',name:'Euro'},
    {code:'GBP',flag:'üá¨üáß',name:'British Pound'},
    {code:'JPY',flag:'üáØüáµ',name:'Japanese Yen'},
    {code:'INR',flag:'üáÆüá≥',name:'Indian Rupee'},
    {code:'SAR',flag:'üá∏üá¶',name:'Saudi Riyal'},
    {code:'SGD',flag:'üá∏üá¨',name:'Singapore Dollar'},
];
const tbody = document.getElementById('currency-comparison-body');
MAJOR.forEach(cur => {
    const r = APPROX_RATES[cur.code] || null;
    const tr = document.createElement('tr');
    if (cur.code === TARGET_CUR) tr.classList.add('highlight-row');
    tr.innerHTML = `
        <td><span class="flag">${cur.flag}</span>${cur.code}
            <span style="font-size:0.75rem;color:var(--text-muted);margin-left:4px;">${cur.name}</span>
        </td>
        <td>${r ? (GOLD_USD_G * r).toLocaleString('en-US',{minimumFractionDigits:2}) : '‚Äî'}</td>
        <td>${r ? (GOLD_USD_OZ * r).toLocaleString('en-US',{minimumFractionDigits:2}) : '‚Äî'}</td>
    `;
    tbody.appendChild(tr);
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHART ‚Äî fetches from /api/gold-history
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let goldChart = null;
let currentDays = 30;

function fmt$(n) {
    return '$' + n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}

async function loadChart(days) {
    currentDays = days;

    // update toggle buttons
    document.querySelectorAll('.chart-toggle button').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.days) === days);
    });
    document.getElementById('chart-range-label').textContent = days + ' days';

    // show loading
    document.getElementById('chart-loading').style.display = 'flex';
    document.getElementById('chart-error').style.display   = 'none';
    document.getElementById('goldChart').style.display     = 'none';

    // reset stat bar
    ['cs-high','cs-low','cs-open','cs-close','cs-pct','cs-avg'].forEach(id => {
        const el = document.getElementById(id);
        el.textContent = '‚Äî';
        el.className = 'csi-value';
    });
    document.getElementById('chart-change-label').textContent = '‚Äî';

    try {
        const resp = await fetch(`/api/gold-history?days=${days}`);
        const data = await resp.json();

        if (data.error) throw new Error(data.error);
        if (!data.labels || data.labels.length === 0) throw new Error('No data returned.');

        const labels = data.labels;
        const prices = data.prices;

        // ‚îÄ‚îÄ compute stats ‚îÄ‚îÄ
        const high  = Math.max(...prices);
        const low   = Math.min(...prices);
        const open  = prices[0];
        const close = prices[prices.length - 1];
        const avg   = prices.reduce((a,b) => a+b, 0) / prices.length;
        const pct   = ((close - open) / open * 100);
        const absDiff = close - open;

        document.getElementById('cs-high').textContent  = fmt$(high);
        document.getElementById('cs-low').textContent   = fmt$(low);
        document.getElementById('cs-open').textContent  = fmt$(open);
        document.getElementById('cs-close').textContent = fmt$(close);
        document.getElementById('cs-avg').textContent   = fmt$(avg);

        const pctEl = document.getElementById('cs-pct');
        pctEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
        pctEl.className   = 'csi-value ' + (pct >= 0 ? 'positive' : 'negative');

        const changeLabel = document.getElementById('chart-change-label');
        changeLabel.textContent = (pct >= 0 ? '‚ñ≤ +' : '‚ñº ') + fmt$(Math.abs(absDiff)) + ' (' + pct.toFixed(2) + '%)';
        changeLabel.style.color = pct >= 0 ? 'var(--success)' : 'var(--danger)';

        // ‚îÄ‚îÄ gradient fill ‚îÄ‚îÄ
        const canvas = document.getElementById('goldChart');
        const ctx    = canvas.getContext('2d');
        const grad   = ctx.createLinearGradient(0, 0, 0, 280);
        grad.addColorStop(0,   'rgba(232,200,74,0.25)');
        grad.addColorStop(0.6, 'rgba(232,200,74,0.05)');
        grad.addColorStop(1,   'rgba(232,200,74,0)');

        // ‚îÄ‚îÄ build or update chart ‚îÄ‚îÄ
        if (goldChart) {
            goldChart.data.labels         = labels;
            goldChart.data.datasets[0].data = prices;
            goldChart.data.datasets[0].backgroundColor = grad;
            goldChart.update('active');
        } else {
            goldChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Gold USD/oz',
                        data: prices,
                        borderColor: '#e8c84a',
                        borderWidth: 2,
                        backgroundColor: grad,
                        fill: true,
                        tension: 0.35,
                        pointRadius: labels.length > 20 ? 0 : 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#e8c84a',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            borderColor: '#2e2e2e',
                            borderWidth: 1,
                            titleColor: '#888880',
                            bodyColor: '#f0ece0',
                            padding: 10,
                            callbacks: {
                                label: ctx => ' $' + ctx.parsed.y.toLocaleString('en-US',{minimumFractionDigits:2})
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(46,46,46,0.6)', drawBorder: false },
                            ticks: {
                                color: '#555550',
                                font: { size: 11 },
                                maxTicksLimit: 8,
                                maxRotation: 0,
                            }
                        },
                        y: {
                            position: 'right',
                            grid: { color: 'rgba(46,46,46,0.6)', drawBorder: false },
                            ticks: {
                                color: '#888880',
                                font: { size: 11 },
                                callback: v => '$' + v.toLocaleString('en-US')
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('chart-loading').style.display = 'none';
        canvas.style.display = 'block';

    } catch (err) {
        document.getElementById('chart-loading').style.display = 'none';
        const errEl = document.getElementById('chart-error');
        errEl.style.display = 'block';
        errEl.innerHTML = `
            <div style="font-size:1.5rem;margin-bottom:8px;">‚ö†</div>
            <strong>Could not load chart data</strong><br>
            <span style="color:var(--text-muted);font-size:0.8rem;">${err.message}</span><br>
            <span style="color:var(--text-muted);font-size:0.75rem;margin-top:6px;display:block;">
                Check your internet connection ‚Äî freegoldapi.com may be temporarily unavailable
            </span>`;
    }
}

/* toggle buttons */
document.querySelectorAll('.chart-toggle button').forEach(btn => {
    btn.addEventListener('click', () => loadChart(parseInt(btn.dataset.days)));
});

/* load on page ready */
loadChart(30);

{% endif %}
</script>

{% endblock %}