{% extends "base.html" %}

{% block content %}

{# â”€â”€ inline page-scoped styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<style>
/* â”€â”€ ticker bar â”€â”€ */
.ticker-bar {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 18px;
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 0.78rem;
    letter-spacing: 0.06em;
    margin-bottom: 28px;
    overflow: hidden;
}
.ticker-dot {
    width: 7px; height: 7px;
    background: var(--success);
    border-radius: 50%;
    flex-shrink: 0;
    animation: pulse 1.8s ease infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50%       { opacity: 0.4; transform: scale(0.7); }
}
.ticker-label { color: var(--text-muted); text-transform: uppercase; }
.ticker-value { color: var(--accent); font-weight: 700; }
.ticker-sep   { color: var(--border); }
#live-clock   { color: var(--text-secondary); font-variant-numeric: tabular-nums; }

/* â”€â”€ page header â”€â”€ */
.market-header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
}
.market-header-left h2 {
    font-family: var(--font-display);
    font-size: 3rem;
    letter-spacing: 0.08em;
    color: var(--accent);
    line-height: 1;
}
.market-header-left p {
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-top: 4px;
}

/* â”€â”€ currency form inline â”€â”€ */
.currency-form {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
}
.currency-form label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin: 0;
    white-space: nowrap;
}
.currency-form input {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 0.9rem;
    padding: 6px 10px;
    width: 80px;
    text-transform: uppercase;
    outline: none;
    transition: border-color var(--transition);
}
.currency-form input:focus { border-color: var(--accent); }
.currency-form button {
    background: var(--accent);
    color: #111;
    border: none;
    border-radius: var(--radius-sm);
    padding: 7px 16px;
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background var(--transition), transform var(--transition);
}
.currency-form button:hover { background: #f0d560; transform: translateY(-1px); }

/* â”€â”€ stat cards row â”€â”€ */
.stat-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 14px;
    margin-bottom: 24px;
}
.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: 3px solid var(--accent);
    border-radius: var(--radius-md);
    padding: 20px 18px;
    position: relative;
    overflow: hidden;
    transition: transform var(--transition), box-shadow var(--transition);
    opacity: 0;
    animation: fadeUp 0.5s ease forwards;
}
.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 28px rgba(0,0,0,0.35);
}
.stat-card::after {
    content: '';
    position: absolute;
    bottom: 0; right: 0;
    width: 80px; height: 80px;
    background: radial-gradient(circle, var(--accent-glow), transparent 70%);
    pointer-events: none;
}
.stat-card:nth-child(1) { animation-delay: 0.05s; }
.stat-card:nth-child(2) { animation-delay: 0.12s; }
.stat-card:nth-child(3) { animation-delay: 0.19s; }
.stat-card:nth-child(4) { animation-delay: 0.26s; }
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
}
.stat-card .sc-label {
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
}
.stat-card .sc-value {
    font-family: var(--font-display);
    font-size: 1.9rem;
    letter-spacing: 0.03em;
    color: var(--text-primary);
    line-height: 1;
}
.stat-card .sc-sub {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 5px;
}

/* â”€â”€ two-column lower section â”€â”€ */
.lower-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    margin-bottom: 24px;
}
@media (max-width: 820px) { .lower-grid { grid-template-columns: 1fr; } }

/* â”€â”€ panel shared â”€â”€ */
.panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 26px 24px;
    position: relative;
    overflow: hidden;
}
.panel-title {
    font-family: var(--font-display);
    font-size: 1.3rem;
    letter-spacing: 0.07em;
    color: var(--text-primary);
    margin-bottom: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.panel-title-icon {
    width: 26px; height: 26px;
    background: var(--accent-glow);
    border: 1px solid var(--accent);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.85rem;
}

/* â”€â”€ gold calculator â”€â”€ */
.calc-input-row {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 14px;
}
.calc-input-row input {
    flex: 1;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 1rem;
    padding: 10px 12px;
    outline: none;
    transition: border-color var(--transition);
}
.calc-input-row input:focus { border-color: var(--accent); }
.calc-unit-toggle {
    display: flex;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
}
.calc-unit-toggle button {
    background: none;
    border: none;
    padding: 8px 14px;
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    cursor: pointer;
    transition: background var(--transition), color var(--transition);
}
.calc-unit-toggle button.active {
    background: var(--accent);
    color: #111;
}
.calc-result {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 18px;
    text-align: center;
    min-height: 72px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.calc-result-value {
    font-family: var(--font-display);
    font-size: 2.2rem;
    letter-spacing: 0.04em;
    color: var(--accent);
    line-height: 1;
}
.calc-result-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 5px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
}

/* â”€â”€ currency comparison table â”€â”€ */
.currency-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.currency-table th {
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
    text-align: left;
}
.currency-table td {
    padding: 10px 10px;
    border-bottom: 1px solid rgba(46,46,46,0.6);
    color: var(--text-secondary);
    transition: background var(--transition);
}
.currency-table tr:hover td { background: var(--surface-2); color: var(--text-primary); }
.currency-table tr:last-child td { border-bottom: none; }
.flag { margin-right: 6px; font-size: 1rem; }
.highlight-row td { color: var(--accent) !important; font-weight: 600; }

/* â”€â”€ full breakdown table â”€â”€ */
.breakdown-panel { margin-bottom: 0; }
.breakdown-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.breakdown-table th {
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    background: var(--surface-2);
    text-align: left;
}
.breakdown-table td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}
.breakdown-table tr:hover td { background: var(--surface-2); }
.breakdown-table tr:last-child td { border-bottom: none; }

/* â”€â”€ no-data state â”€â”€ */
.no-data {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}
.no-data-icon { font-size: 2.5rem; margin-bottom: 12px; }
.no-data p { font-size: 0.9rem; letter-spacing: 0.06em; }
</style>

{# â”€â”€ PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div style="max-width: 1100px; margin: 0 auto;">

    {# Ticker bar #}
    <div class="ticker-bar">
        <span class="ticker-dot"></span>
        <span class="ticker-label">Live</span>
        {% if market_data %}
            <span class="ticker-value">XAU/USD ${{ market_data.gold_usd_oz }}</span>
            <span class="ticker-sep">|</span>
            <span class="ticker-label">1 USD =</span>
            <span class="ticker-value">{{ market_data.rate }} {{ market_data.currency }}</span>
            <span class="ticker-sep">|</span>
        {% endif %}
        <span class="ticker-label">ğŸ•</span>
        <span id="live-clock">--:--:--</span>
    </div>

    {# Header + form #}
    <div class="market-header">
        <div class="market-header-left">
            <h2>Market Dashboard</h2>
            <p>Live Gold Prices &amp; Currency Exchange</p>
        </div>
        <form method="POST" class="currency-form">
            {{ form.hidden_tag() }}
            <label for="{{ form.currency.id }}">Currency</label>
            {{ form.currency(class="", placeholder="AED", value=market_data.currency if market_data else "AED", id=form.currency.id) }}
            {{ form.submit(class="") }}
        </form>
    </div>

    {# Error #}
    {% if error %}
        <div class="weather-error" style="margin-bottom: 20px;">âš  {{ error }}</div>
    {% endif %}

    {% if market_data %}

    {# â”€â”€ STAT CARDS â”€â”€ #}
    <div class="stat-row">
        <div class="stat-card">
            <div class="sc-label">Gold â€” USD / oz</div>
            <div class="sc-value" data-count="{{ market_data.gold_usd_oz }}" data-prefix="$" data-decimals="2">$0</div>
            <div class="sc-sub">Troy ounce spot price</div>
        </div>
        <div class="stat-card">
            <div class="sc-label">Gold â€” {{ market_data.currency }} / oz</div>
            <div class="sc-value" data-count="{{ market_data.gold_target_oz }}" data-suffix=" {{ market_data.currency }}" data-decimals="2">0</div>
            <div class="sc-sub">Converted at live rate</div>
        </div>
        <div class="stat-card">
            <div class="sc-label">Gold â€” USD / gram</div>
            <div class="sc-value" data-count="{{ market_data.gold_usd_g }}" data-prefix="$" data-decimals="2">$0</div>
            <div class="sc-sub">Per gram (31.1g / oz)</div>
        </div>
        <div class="stat-card">
            <div class="sc-label">Exchange Rate</div>
            <div class="sc-value" data-count="{{ market_data.rate }}" data-decimals="4">0</div>
            <div class="sc-sub">1 USD â†’ {{ market_data.currency }}</div>
        </div>
    </div>

    {# â”€â”€ TWO-COL SECTION â”€â”€ #}
    <div class="lower-grid">

        {# Gold Calculator #}
        <div class="panel">
            <div class="panel-title">
                <span class="panel-title-icon">âš–</span>
                Gold Value Calculator
            </div>

            <div class="calc-input-row">
                <input
                    type="number"
                    id="calc-amount"
                    placeholder="Enter amount..."
                    min="0"
                    step="0.01"
                    style="max-width: 100%;"
                />
                <div class="calc-unit-toggle">
                    <button type="button" class="active" data-unit="grams">g</button>
                    <button type="button" data-unit="oz">oz</button>
                    <button type="button" data-unit="kg">kg</button>
                    <button type="button" data-unit="tola">tola</button>
                </div>
            </div>

            <div class="calc-result" id="calc-result-box">
                <div class="calc-result-value" id="calc-result-usd">â€”</div>
                <div class="calc-result-label" id="calc-result-label">Enter an amount above</div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;">
                <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center;">
                    <div style="font-size:0.7rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;">USD</div>
                    <div style="font-family:var(--font-display);font-size:1.3rem;color:var(--text-primary);" id="calc-usd-side">â€”</div>
                </div>
                <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center;">
                    <div style="font-size:0.7rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;">{{ market_data.currency }}</div>
                    <div style="font-family:var(--font-display);font-size:1.3rem;color:var(--accent);" id="calc-target-side">â€”</div>
                </div>
            </div>
        </div>

        {# Multi-Currency Comparison #}
        <div class="panel">
            <div class="panel-title">
                <span class="panel-title-icon">ğŸŒ</span>
                Gold Price in Major Currencies
            </div>
            <table class="currency-table">
                <thead>
                    <tr>
                        <th>Currency</th>
                        <th>Per Gram</th>
                        <th>Per Ounce</th>
                    </tr>
                </thead>
                <tbody id="currency-comparison-body">
                    {# Populated by JS using rates from market_data #}
                </tbody>
            </table>
        </div>
    </div>

    {# â”€â”€ FULL BREAKDOWN TABLE â”€â”€ #}
    <div class="panel breakdown-panel">
        <div class="panel-title">
            <span class="panel-title-icon">ğŸ“‹</span>
            Full Market Breakdown
        </div>
        <table class="breakdown-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                    <th>Unit</th>
                    <th>Source</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Spot Price (USD)</td>
                    <td style="color:var(--text-primary);font-weight:600;">${{ market_data.gold_usd_oz }}</td>
                    <td>USD / troy oz</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">GoldAPI.io</td>
                </tr>
                <tr>
                    <td>Spot Price ({{ market_data.currency }})</td>
                    <td style="color:var(--accent);font-weight:600;">{{ market_data.gold_target_oz }}</td>
                    <td>{{ market_data.currency }} / troy oz</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">Calculated</td>
                </tr>
                <tr>
                    <td>Price per Gram (USD)</td>
                    <td style="color:var(--text-primary);font-weight:600;">${{ market_data.gold_usd_g }}</td>
                    <td>USD / g</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">Calculated</td>
                </tr>
                <tr>
                    <td>Price per Gram ({{ market_data.currency }})</td>
                    <td style="color:var(--accent);font-weight:600;">{{ market_data.gold_target_g }}</td>
                    <td>{{ market_data.currency }} / g</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">Calculated</td>
                </tr>
                <tr>
                    <td>Exchange Rate</td>
                    <td style="color:var(--text-primary);font-weight:600;">{{ market_data.rate }}</td>
                    <td>USD â†’ {{ market_data.currency }}</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">Open Exchange Rates</td>
                </tr>
                <tr>
                    <td>Last Update</td>
                    <td style="color:var(--text-secondary);">{{ market_data.updated }}</td>
                    <td>UTC</td>
                    <td style="color:var(--text-muted);font-size:0.82rem;">System</td>
                </tr>
            </tbody>
        </table>
    </div>

    {% else %}

    {# â”€â”€ NO DATA STATE â”€â”€ #}
    <div class="panel">
        <div class="no-data">
            <div class="no-data-icon">ğŸ“Š</div>
            <p>Enter a currency code above and hit <strong style="color:var(--accent);">Update</strong> to load live market data.</p>
            <p style="margin-top:8px; font-size:0.8rem;">Try: AED Â· EUR Â· GBP Â· JPY Â· INR Â· SGD</p>
        </div>
    </div>

    {% endif %}

</div>

{# â”€â”€ JAVASCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<script>
/* â”€â”€ live clock â”€â”€ */
function updateClock() {
    const now = new Date();
    document.getElementById('live-clock').textContent =
        now.toUTCString().slice(17, 25) + ' UTC';
}
updateClock();
setInterval(updateClock, 1000);

{% if market_data %}

/* â”€â”€ animated number counter â”€â”€ */
function animateCount(el) {
    const target   = parseFloat(el.dataset.count);
    const prefix   = el.dataset.prefix  || '';
    const suffix   = el.dataset.suffix  || '';
    const decimals = parseInt(el.dataset.decimals) || 0;
    const duration = 900;
    const start    = performance.now();

    function step(now) {
        const progress = Math.min((now - start) / duration, 1);
        const ease     = 1 - Math.pow(1 - progress, 3);
        const value    = (target * ease).toFixed(decimals);
        el.textContent = prefix + Number(value).toLocaleString(undefined, {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }) + suffix;
        if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

document.querySelectorAll('[data-count]').forEach(animateCount);

/* â”€â”€ gold calculator â”€â”€ */
const GOLD_USD_G   = {{ market_data.gold_usd_g }};
const GOLD_USD_OZ  = {{ market_data.gold_usd_oz }};
const RATE         = {{ market_data.rate }};
const TARGET_CUR   = "{{ market_data.currency }}";

const unitFactors = {
    grams: 1,
    oz:    31.1035,
    kg:    1000,
    tola:  11.6638  /* 1 tola = 11.6638g */
};

let activeUnit = 'grams';

document.querySelectorAll('.calc-unit-toggle button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.calc-unit-toggle button')
            .forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeUnit = btn.dataset.unit;
        recalculate();
    });
});

document.getElementById('calc-amount').addEventListener('input', recalculate);

function recalculate() {
    const raw = parseFloat(document.getElementById('calc-amount').value);
    const resultBox   = document.getElementById('calc-result-box');
    const resultVal   = document.getElementById('calc-result-usd');
    const resultLabel = document.getElementById('calc-result-label');
    const usdSide     = document.getElementById('calc-usd-side');
    const targetSide  = document.getElementById('calc-target-side');

    if (isNaN(raw) || raw <= 0) {
        resultVal.textContent   = 'â€”';
        resultLabel.textContent = 'Enter an amount above';
        usdSide.textContent     = 'â€”';
        targetSide.textContent  = 'â€”';
        return;
    }

    const grams   = raw * unitFactors[activeUnit];
    const usdVal  = grams * GOLD_USD_G;
    const tgtVal  = usdVal * RATE;

    const fmt = (n, prefix='') => prefix + n.toLocaleString('en-US', {
        minimumFractionDigits: 2, maximumFractionDigits: 2
    });

    resultVal.textContent   = fmt(usdVal, '$');
    resultLabel.textContent = `${raw} ${activeUnit} of gold â‰ˆ ${fmt(tgtVal)} ${TARGET_CUR}`;
    usdSide.textContent     = fmt(usdVal, '$');
    targetSide.textContent  = fmt(tgtVal);
}

/* â”€â”€ multi-currency comparison (using hardcoded popular rates relative to USD) â”€â”€ */
/* We derive them from the rate the server already gave us for the target currency.
   For the major currencies below we use fixed approximate cross-rates.
   They serve as a comparison â€” real rates require extra API calls. */
const MAJOR = [
    { code: 'AED', flag: 'ğŸ‡¦ğŸ‡ª', name: 'UAE Dirham' },
    { code: 'USD', flag: 'ğŸ‡ºğŸ‡¸', name: 'US Dollar' },
    { code: 'EUR', flag: 'ğŸ‡ªğŸ‡º', name: 'Euro' },
    { code: 'GBP', flag: 'ğŸ‡¬ğŸ‡§', name: 'British Pound' },
    { code: 'JPY', flag: 'ğŸ‡¯ğŸ‡µ', name: 'Japanese Yen' },
    { code: 'INR', flag: 'ğŸ‡®ğŸ‡³', name: 'Indian Rupee' },
    { code: 'SAR', flag: 'ğŸ‡¸ğŸ‡¦', name: 'Saudi Riyal' },
    { code: 'SGD', flag: 'ğŸ‡¸ğŸ‡¬', name: 'Singapore Dollar' },
];

/* Known approximate fixed rates vs USD (good enough for comparison panel) */
const APPROX_RATES = {
    USD: 1,
    AED: 3.6725,
    EUR: 0.92,
    GBP: 0.79,
    JPY: 149.5,
    INR: 83.1,
    SAR: 3.75,
    SGD: 1.34,
};

/* Override with the live rate we already have for the selected currency */
APPROX_RATES["{{ market_data.currency }}"] = RATE;

const tbody = document.getElementById('currency-comparison-body');
MAJOR.forEach(cur => {
    const r          = APPROX_RATES[cur.code] || null;
    const perG       = r ? (GOLD_USD_G  * r).toFixed(2) : 'â€”';
    const perOz      = r ? (GOLD_USD_OZ * r).toFixed(2) : 'â€”';
    const isSelected = cur.code === TARGET_CUR;

    const tr = document.createElement('tr');
    if (isSelected) tr.classList.add('highlight-row');
    tr.innerHTML = `
        <td><span class="flag">${cur.flag}</span>${cur.code}
            <span style="font-size:0.75rem;color:var(--text-muted);margin-left:4px;">${cur.name}</span>
        </td>
        <td>${r ? Number(perG).toLocaleString('en-US',{minimumFractionDigits:2}) : 'â€”'}</td>
        <td>${r ? Number(perOz).toLocaleString('en-US',{minimumFractionDigits:2}) : 'â€”'}</td>
    `;
    tbody.appendChild(tr);
});

{% endif %}
</script>

{% endblock %}